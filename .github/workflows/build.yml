name: Build Windows Executable with PyInstaller

on:
  push:
    branches:
      - main
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

jobs:
  build_windows:
    runs-on: windows-latest  # Use a Windows runner for the build
    # This permission is required for the action to create a GitHub Release
    permissions:
      contents: write
    # Define the version once at the job level for easy updates
    env:
      ARDUINO_CLI_VERSION: 1.3.1 # Set the specific version you want to use

    steps:
      - name: â¬‡ï¸ Checkout Repository
        uses: actions/checkout@v4
      
      - name: ğŸ“‚ Move Source Files to Root
        # This step moves the contents of the 'Source' directory
        # to the root of the workspace (where the workflow runs).
        run: |
          # Use Move-Item (mv) to move the *contents* of the Source folder
          # The -Force argument handles potential overwrites, though unlikely here.
          # The destination '.' means the current directory (the workspace root).
          Move-Item -Path .\Source\* -Destination .\ -Force
          # You might want to remove the now-empty Source folder
          Remove-Item -Path .\Source -Recurse -Force
          # --- This is the implementation of Step 2 from your README ---
          
      - name: Download and Install arduino-cli (Step 2 & 3)
        shell: pwsh
        run: |
          # Construct the download URL
          $url = "https://github.com/arduino/arduino-cli/releases/download/v${{ env.ARDUINO_CLI_VERSION }}/arduino-cli_${{ env.ARDUINO_CLI_VERSION }}_Windows_64bit.zip"
          $outputZip = "arduino-cli.zip"
          
          # Download the file
          Write-Host "Downloading arduino-cli from $url"
          Invoke-WebRequest -Uri $url -OutFile $outputZip
          
          # Extract the zip file
          Write-Host "Extracting $outputZip"
          Expand-Archive -Path $outputZip -DestinationPath .
          
          # Clean up the downloaded zip
          Write-Host "Cleaning up $outputZip"
          Remove-Item -Path $outputZip
          
          Write-Host "arduino-cli.exe is ready in the Source directory."
          
      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x' # Specify your required Python version

      - name: ğŸ“¦ Install Dependencies
        # Use Windows-style commands (e.g., venv activation)
        run: |
          python -m venv .venv
          # Activation on Windows uses ".\.venv\Scripts\activate"
          .venv\Scripts\activate
          python -m pip install --upgrade pip
          # Replace requirements.txt with your actual requirements file
          # pip install -r requirements.txt
          # Install PyInstaller
          pip install pyinstaller PyQt5 pyserial Pillow

      - name: ğŸ”¨ Build with PyInstaller
        # Adjust the command and options as needed:
        # The result will be an .exe file in the 'dist' folder when using --onefile
        run: |
          .venv\Scripts\activate
          # Note: The icon should be a .ico file on Windows
          pyinstaller --onefile --windowed --add-data="arduino-cli.exe:." --name "HEX_Flasher" ArduinoFlasher_1.0.py


      # 7. Create or Update the "latest" Release
      - name: Create or Update "latest" Release
Â  Â  Â  Â  env:
Â  Â  Â  Â  Â  # The GITHUB_TOKEN is automatically provided by Actions
Â  Â  Â  Â  Â  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
Â  Â  Â  Â  shell: bash  # <-- FIX 1: Explicitly use bash shell for '||' logic
Â  Â  Â  Â  run: |
Â  Â  Â  Â  Â  # Try to create the release.
Â  Â  Â  Â  Â  # All flags are continued with '\' to make one long command
Â  Â  Â  Â  Â  gh release create latest \
Â  Â  Â  Â  Â  Â  --title "Latest Windows Build" \
Â  Â  Â  Â  Â  Â  --notes "Automatic build from the main branch." \
Â  Â  Â  Â  Â  Â  --latest \
Â  Â  Â  Â  Â  Â  --prerelease=false \
Â  Â  Â  Â  Â  Â  --draft=false \
Â  Â  Â  Â  Â  Â  ./dist/HEX_Flasher.exe
Â  Â  Â  Â  Â  # FIX 2: The '||' operator is on its own line.
Â  Â  Â  Â  Â  # It runs the (...) block only if the 'gh release create' command above fails.
Â  Â  Â  Â  Â  ||
Â  Â  Â  Â  Â  (
Â  Â  Â  Â  Â  Â  echo "Release 'latest' already exists. Re-creating..." ;
Â  Â  Â  Â  Â  Â  # Delete the existing release
Â  Â  Â  Â  Â  Â  gh release delete latest -y ;
Â  Â  Â  Â  Â  Â  echo "Old release deleted. Re-creating..." ;
Â  Â  Â  Â  Â  Â  # Re-create the release
Â  Â  Â  Â  Â  Â  gh release create latest \
Â  Â  Â  Â  Â  Â  Â  --title "Latest Windows Build" \
Â  Â  Â  Â  Â  Â  Â  --notes "Automatic build from the main branch." \
Â  Â  Â  Â  _ Â  Â  Â  --latest \
Â  Â  Â  Â  Â  Â  Â  --prerelease=false \
Â  Â  Â  Â  Â  Â  Â  --draft=false \
Â  Â  Â  Â  Â  Â  Â  ./dist/HEX_Flasher.exe
Â  Â  Â  Â  Â  Â  # FIX 3: No '\' at the end of the last command in the block
Â  Â  _ Â  )

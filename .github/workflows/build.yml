name: Build Windows Executable with PyInstaller

on:
  push:
    branches:
      - main
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

jobs:
  build_windows:
    runs-on: windows-latest  # Use a Windows runner for the build
    # This permission is required for the action to create a GitHub Release
    permissions:
      contents: write
    # Define the version once at the job level for easy updates
    env:
      ARDUINO_CLI_VERSION: 1.3.1 # Set the specific version you want to use

    steps:
      - name: ‚¨áÔ∏è Checkout Repository
        uses: actions/checkout@v4
      
      - name: üìÇ Move Source Files to Root
        # This step moves the contents of the 'Source' directory
        # to the root of the workspace (where the workflow runs).
        run: |
          # Use Move-Item (mv) to move the *contents* of the Source folder
          # The -Force argument handles potential overwrites, though unlikely here.
          # The destination '.' means the current directory (the workspace root).
          Move-Item -Path .\Source\* -Destination .\ -Force
          # You might want to remove the now-empty Source folder
          Remove-Item -Path .\Source -Recurse -Force
          # --- This is the implementation of Step 2 from your README ---
          
      - name: Download and Install arduino-cli (Step 2 & 3)
        shell: pwsh
        run: |
          # Construct the download URL
          $url = "https://github.com/arduino/arduino-cli/releases/download/v${{ env.ARDUINO_CLI_VERSION }}/arduino-cli_${{ env.ARDUINO_CLI_VERSION }}_Windows_64bit.zip"
          $outputZip = "arduino-cli.zip"
          
          # Download the file
          Write-Host "Downloading arduino-cli from $url"
          Invoke-WebRequest -Uri $url -OutFile $outputZip
          
          # Extract the zip file
          Write-Host "Extracting $outputZip"
          Expand-Archive -Path $outputZip -DestinationPath .
          
          # Clean up the downloaded zip
          Write-Host "Cleaning up $outputZip"
          Remove-Item -Path $outputZip
          
          Write-Host "arduino-cli.exe is ready in the Source directory."
          
      - name: üêç Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x' # Specify your required Python version

      - name: üì¶ Install Dependencies
        # Use Windows-style commands (e.g., venv activation)
        run: |
          python -m venv .venv
          # Activation on Windows uses ".\.venv\Scripts\activate"
          .venv\Scripts\activate
          python -m pip install --upgrade pip
          # Replace requirements.txt with your actual requirements file
          # pip install -r requirements.txt
          # Install PyInstaller
          pip install pyinstaller PyQt5 pyserial Pillow

      - name: üî® Build with PyInstaller
        # Adjust the command and options as needed:
        # The result will be an .exe file in the 'dist' folder when using --onefile
        run: |
          .venv\Scripts\activate
          # Note: The icon should be a .ico file on Windows
          pyinstaller --onefile --windowed --add-data="arduino-cli.exe:." --name "HEX_Flasher" ArduinoFlasher_1.0.py


      # 7. Create or Update the "latest" Release
      - name: Create or Update "latest" Release
        env:
          # The GITHUB_TOKEN is automatically provided by Actions
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Try to create the release. This will tag the current commit as "latest"
          gh release create latest `
            --title "Latest Windows Build (main)" `
            --notes "Automatic build from the main branch." `
            --latest `
            --prerelease=false `
            --draft=false `
            ./ESP_Flasher.zip `
          || `
          ( `
            echo "Release 'latest' already exists. Re-creating..." ; `
            # Delete the existing release. This also deletes the "latest" tag.
            gh release delete latest -y ; `
            # Re-create the release, which will tag the current commit as "latest"
            gh release create latest `
              --title "Latest Windows Build (main)" `
              --notes "Automatic build from the main branch." `
              --latest `
              --prerelease=false `
              --draft=false `
              ./ESP_Flasher.zip `
          )
